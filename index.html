<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Jewellery Background Remover</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f7f7f7;
      padding: 20px;
    }
    #upload { margin-top: 15px; }
    #preview, #output {
      margin-top: 20px;
      max-width: 90%;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    #btns {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    #processBtn { background: gold; color: #000; font-weight: bold; }
    #downloadBtn { background: green; color: #fff; display:none; }
    #shareBtn { background: #4285f4; color: #fff; display:none; }
  </style>
</head>
<body>

  <h2>✨ Jewellery Background Remover ✨</h2>
  <input type="file" id="upload" accept="image/*" capture="environment">
  <br>
  <img id="preview" style="display:none;">
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="output" style="display:none;">

  <div id="btns">
    <button id="processBtn" style="display:none;">Remove Background</button>
    <button id="downloadBtn">Download</button>
    <button id="shareBtn">Share</button>
  </div>

  <!-- Load ONNX runtime (for AI model) -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <script>
    const upload = document.getElementById('upload');
    const preview = document.getElementById('preview');
    const canvas = document.getElementById('canvas');
    const output = document.getElementById('output');
    const processBtn = document.getElementById('processBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const shareBtn = document.getElementById('shareBtn');

    let uploadedFile;

    // Step 1: Preview image
    upload.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      uploadedFile = file;
      const reader = new FileReader();
      reader.onload = evt => {
        preview.src = evt.target.result;
        preview.style.display = 'block';
        processBtn.style.display = 'inline-block';
      };
      reader.readAsDataURL(file);
    });

    // Step 2: Load U²-Net model (hosted ONNX file)
    let session;
    async function loadModel() {
      if (!session) {
        session = await ort.InferenceSession.create(
          "https://huggingface.co/onnx/models/resolve/main/u2net/u2net.onnx"
        );
        console.log("Model loaded ✅");
      }
    }
    loadModel();

    // Step 3: Background removal
    processBtn.addEventListener('click', async () => {
      if (!session || !uploadedFile) return;

      const img = new Image();
      img.src = URL.createObjectURL(uploadedFile);
      await img.decode();

      // Resize to model input (320x320)
      canvas.width = 320;
      canvas.height = 320;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, 320, 320);

      // Convert to tensor
      const imgData = ctx.getImageData(0, 0, 320, 320);
      const float32Data = new Float32Array(320 * 320 * 3);
      for (let i = 0; i < 320 * 320; i++) {
        float32Data[i * 3 + 0] = imgData.data[i * 4] / 255;
        float32Data[i * 3 + 1] = imgData.data[i * 4 + 1] / 255;
        float32Data[i * 3 + 2] = imgData.data[i * 4 + 2] / 255;
      }

      const tensor = new ort.Tensor("float32", float32Data, [1, 3, 320, 320]);

      // Run inference
      const results = await session.run({ "input": tensor });
      const mask = results[Object.keys(results)[0]].data;

      // Apply mask
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0, img.width, img.height);
      const original = ctx.getImageData(0, 0, img.width, img.height);
      for (let i = 0; i < mask.length; i++) {
        const alpha = mask[i] > 0.5 ? 255 : 0;
        original.data[i * 4 + 3] = alpha;
      }
      ctx.putImageData(original, 0, 0);

      output.src = canvas.toDataURL("image/png");
      output.style.display = "block";
      downloadBtn.style.display = "inline-block";
      shareBtn.style.display = "inline-block";
    });

    // Step 4: Download
    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.href = output.src;
      link.download = "jewellery_cutout.png";
      link.click();
    });

    // Step 5: Share
    shareBtn.addEventListener('click', async () => {
      if (navigator.share) {
        try {
          const blob = await (await fetch(output.src)).blob();
          const file = new File([blob], "jewellery_cutout.png", { type: blob.type });
          await navigator.share({
            title: "Jewellery Image",
            text: "Check out this background-removed jewellery!",
            files: [file]
          });
        } catch (err) {
          alert("Share failed: " + err.message);
        }
      } else {
        alert("Sharing not supported on this device.");
      }
    });
  </script>
</body>
</html>
